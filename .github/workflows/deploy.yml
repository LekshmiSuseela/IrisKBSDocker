name: CI/CD Pipeline for IRIS

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: iris-api
  GAR_LOCATION: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/iris-api-repo/iris-api

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Step 3: Install and configure gcloud
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Step 4: Configure Docker to use Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: |
          echo "üß© Configuring Docker authentication for region: ${{ secrets.GCP_REGION }}"
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet
          echo "‚úÖ Docker configured successfully."

      # Step 5: Build Docker Image
      - name: Build Docker Image
        run: |
          echo "üî® Building Docker image..."
          echo "Image tag: $GAR_LOCATION:${{ github.sha }}"
          docker build -t $GAR_LOCATION:${{ github.sha }} .
          echo "‚úÖ Docker image built successfully."

      # Step 6: Push Docker Image
      - name: Push Docker Image
        run: |
          echo "üöÄ Pushing image to Artifact Registry..."
          echo "Image: $GAR_LOCATION:${{ github.sha }}"
          docker push $GAR_LOCATION:${{ github.sha }}
          echo "‚úÖ Image pushed successfully."

      # Step 7: Get GKE credentials
      - name: Get GKE credentials
        run: |
          echo "üéØ Getting GKE credentials..."
          echo "Cluster: ${{ secrets.GKE_CLUSTER }}, Zone: ${{ secrets.GKE_ZONE }}"
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} \
            --zone ${{ secrets.GKE_ZONE }} \
            --project ${{ secrets.GCP_PROJECT_ID }}
          echo "‚úÖ GKE credentials configured successfully."
          kubectl config current-context

      # Step 8: Verify Kubernetes connection
      - name: Verify Kubernetes Context
        run: |
          echo "üîç Verifying Kubernetes connection..."
          kubectl get nodes || (echo "‚ùå Failed to connect to GKE cluster" && exit 1)
          kubectl get ns
          echo "‚úÖ Kubernetes cluster reachable."

      # Step 9: Deploy to GKE
      - name: Deploy to GKE
        run: |
          echo "üö¢ Deploying image to GKE..."
          echo "Updating deployment: iris-api with image: $GAR_LOCATION:${{ github.sha }}"
          kubectl set image deployment/iris-api iris-api=$GAR_LOCATION:${{ github.sha }} --namespace=default || (echo "‚ùå Failed to update image" && exit 1)
          
          echo "‚è≥ Waiting for rollout to complete..."
          kubectl rollout status deployment/iris-api --namespace=default || (echo "‚ùå Rollout failed" && exit 1)

          echo "‚úÖ Deployment successful!"
