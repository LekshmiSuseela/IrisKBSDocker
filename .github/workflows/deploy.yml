name: CI/CD Pipeline for IRIS (debug)

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: iris-api
  GAR_LOCATION: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/iris-api-repo/iris-api

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Print Context Info
        run: |
          echo "‚úÖ Workflow triggered on branch: ${{ github.ref }}"
          echo "Repo: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Working directory:"
          pwd
          echo "Files:"
          ls -al

      - name: üß© Debug Secret Existence
        run: |
          echo "Checking for required secrets..."
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then echo "‚ùå Missing GCP_PROJECT_ID"; exit 1; fi
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then echo "‚ùå Missing GCP_SA_KEY"; exit 1; fi
          if [ -z "${{ secrets.GCP_REGION }}" ]; then echo "‚ùå Missing GCP_REGION"; exit 1; fi
          if [ -z "${{ secrets.GKE_CLUSTER }}" ]; then echo "‚ùå Missing GKE_CLUSTER"; exit 1; fi
          if [ -z "${{ secrets.GKE_ZONE }}" ]; then echo "‚ùå Missing GKE_ZONE"; exit 1; fi
          echo "‚úÖ All required secrets appear to exist."

      - name: üîê Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚òÅÔ∏è Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: üê≥ Configure Docker for Artifact Registry
        run: |
          set -x
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: üß± Build Docker Image
        run: |
          set -x
          echo "Building Docker image..."
          docker build -t $GAR_LOCATION:${{ github.sha }} .

      - name: üöÄ Push Docker Image
        run: |
          set -x
          docker push $GAR_LOCATION:${{ github.sha }}

      - name: ‚ò∏Ô∏è Get GKE Credentials
        run: |
          set -x
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} \
            --zone ${{ secrets.GKE_ZONE }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: üß© Deploy to GKE
        run: |
          set -x
          echo "Deploying to GKE..."
          kubectl set image deployment/iris-api iris-api=$GAR_LOCATION:${{ github.sha }} --namespace=default
          kubectl rollout status deployment/iris-api --namespace=default
